---
title: "plotParms"
author: "Dan Murphy"
date: "October 24, 2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Description

*plotParms* is a generic function in the *ChainLadder* package
that plots various parameters estimated by models in the package.
Currently two models are supported:

* chainladder
* MackChainLadder

For those models, plots of six parameters
are available to be rendered by *ggplot*:

1. estimated link ratios **f**
1. estimated link ratios **f** less unity
1. estimated **sigma** values
1. estimated standard error of the link ratios **f.se**
1. coefficient of variation of the link ratios
1. coefficient of variation of the link ratios less unity

By default,
plots 1, 3, 4, and 6 are displayed in a 2x2 grid
(using *gridExtra::marrangeGrob*).
Some display flexibility is enabled;
see **Arguments** section below.

## Details

### chainladder

The *chainladder* function uses *lm* to estimate 
average age-to-age factors for a given actuarial *Triangle*.
In particular, when a development period has only one observation
there is insufficient data for *lm* to estimate the **sigma**
parameter of that period's regression model
(as often occurs in the last period of a *summarized triangle*).
In that case, 
the value of the **sigma** parameter
(and dependent parameters) 
is technically **NA** and
*plotParms* indicates such with:

* a broken line at that point
* a point value at zero (for want of a better choice)
* a legend entry indicating that the source of the parameter is **NA**

For the **GenIns** triangle in *ChainLadder*,
Figure 1 below is a plot of the weighted average link ratios,
the standard error of the residuals,
the standard error of the estimated link ratios,
and the coefficient of variation of the link ratios less unity:
```{r echo=FALSE}
suppressPackageStartupMessages(library(ChainLadder))
```
```{r, fig.cap="chainladder(GenIns)"}
plotParms(chainladder(GenIns))
```

Both the *chainladder* function and 
*plotParms* borrow the *f* notation of Mack^[Thomas Mack. 
Distribution-free calculation of the standard error of 
chain ladder reserve estimates. 
Astin Bulletin. Vol. 23. No 2. 1993. pp.213:225.].
The legend indicates the source of the parameter's value:

* lm: produced by the underlying regression
* NA: not available
* calc: the coefficient of variation is always a calculated value 
(cv(f) = f/f.se) or NA

### MackChainLadder

The *ChainLadder* package's *MackChainLadder* model uses
*chainladder* to estimate parameters
and extends that method's capabilities for two situations:

* sigma = NA
* a tail

#### sigma = NA

When *Triangle* has insufficient data to estimate **sigma**
for a given development period,
*MackChainLadder* has two methods for estimating ("imputing") a value:

* log-linear regression (the default)
* the method of *Mack*

#### tail

For a 10x10 triangle,
*chainladder* generates nine factors.
In contrast,
*MackChainLadder* generates 10 factors because
*that method always includes a tail factor*
(default value is 1.000).
The user can provide a tail,
e.g., with **tail = 1.10**,
or can request *MackChainLadder* estimate a tail by specifying
**tail = TRUE**.
**sigma** and **se** tail parameters are determined by arguments
**tail.sigma** and **tail.se**
which the user can provide explicitly.
If not provided *MackChainLadder* can estimate their values.
Refer to the *MackChainLadder* documentation for more information.

Figure 2 below is the default plot of the parameters of the
*MackChainLadder* model of the **GenIns** triangle.
Ten factors are plotted.
The NA value of **sigma** for the ninth link ratio 
in Figure 1 above is replaced with a value imputed via log-linear regression.
The associated **f.se** 
and **cv** values may now be calculated.
The default unity tail value is shown but, 
since a unity value is assumed to be deterministic,
**tail.sigma** and **tail.se** values are not available.

```{r, fig.cap="MackChainLadder(GenIns)"}
plotParms(MackChainLadder(GenIns))
```

## Arguments

*plotParms* for the two methods in this document is invoked as follows:

```
plotParms(x, which, ncol, nrow, title)
```

* x
    + a *chainladder* or *MackChainLadder* object
    + no default
* which
    + a subset of integers 1 through 6
    + default: 1, 3, 4, 6 -- see list in **Description** section above
    + follows in the tradition of *ChainLadder::plot.glmReserve* 
    by Wayne Zhang as well as *stats::plot.lm*
* ncol
    + number of columns in the multi-plot output
    + default: either 2, or 1 if only one plot is requested
* nrow
    + number of rows in the multi-plot output
    + default: sufficient number to display all plots on one page
  given the number of plots selected and the **ncol** value
* title
    + overall title to display at the top of the output page
    + default: method's call

## Final Example

In this last example 
we implement the *Mack Method* on the **GenIns** triangle
by specifying two key arguments:

* mse.method = "Mack" (the default, but here specified 
explicitly)
tells *MackChainLadder*'s recursion steps to duplicate Mack's 
closed form formula
* est.sigma = "Mack" (not the default)
tells *MackChainLadder* to use Mack's
heuristic formula for imputing **sigma** values
when not available from a *chainladder* regression

We also ask for a tail and associated uncertainty parameters 
to be estimated:
**tail = TRUE**, **tail.sigma = NULL**, and **tail.se = NULL**.

Finally,
we tell *plotParms* to display all six plots
and specify our own more succinct title
because the default
is too wide to fit in the display.

Notice that in this example all **cv** parameter values
are calculated.
Also, by comparing **cv(f-1)~9~** points in Figures 2 and 3, 
the difference between 
**mse.method = "log-linear"** (Figure 2)
and **mse.method = "Mack"** (Figure 3)
does not appear to be significant for this triangle.

```{r, fig.cap="Mack Method on GenIns"}
x <- MackChainLadder(GenIns, est.sigma = "Mack", mse.method = "Mack",
             tail = TRUE, tail.sigma = NULL, tail.se = NULL)
plotParms(x, which = 1:6, title = "Mack Method on GenIns: Estimated Parameters")
```